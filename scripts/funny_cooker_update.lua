-- å¨è‰º
-- æ‹¥æœ‰ç²¾æ¹›å¨è‰ºçš„å¨å¸ˆå¹¶ä¸ä¾èµ–ç‚Šå…·ï¼Œç”šè‡³ä¸ä¾èµ–é£Ÿæï¼Œéšæ—¶éšåœ°å³å…´å‘æŒ¥åšå‡ºä¸€æ¡Œå¥½èœ
-- Section 1ï¼šä¸‹é¥­æ“ä½œ Meal-worthy Play
-- 1 â€œæ²ƒåˆ©çœ‹åˆ°åˆ«äººåšå‡ºåƒåœ¾æ–™ç†æ—¶ï¼Œè¢«æ¿€å‘å¨å¸ˆçµé­‚ï¼Œåšå‡ºä¸‹é¥­èœâ€ï¼Œå±•ç¤ºå¨è‰ºï¼Œå½“åœºè·Ÿé™ªä¸€ä»½ä¸‹é¥­èœï¼šå°±åœ°è‡ªåŠ¨çƒ¹é¥ªä¸€ä»½éšæœºä¸‹é¥­èœ
--   èƒ¡ä¹±çƒ¹é¥ªï¼šæ½®æ¹¿é»ç³Šï¼Œç²‰æœ«è›‹ç³•ï¼Œæ€ªç‰©åƒå±‚é¥¼ï¼Œæ€ªç‰©é‘é¼ï¼Œæ›¼å¾·æ‹‰è‰æ±¤
--   èƒ¡ä¹±çƒ¤ï¼šæ›¼å¾·æ‹‰è‰ å¤œè“ é«˜è„šé¸Ÿè›‹ å­µåŒ–ä¸­çš„é«˜è„šé¸Ÿè›‹ é¾™è™¾ çº¢è˜‘è‡ æœˆäº®è˜‘è‡ è±¡é¼»ã€å†¬è±¡é¼»
--   èƒ¡ä¹±åƒï¼ˆé€šç”¨ï¼‰ï¼šç‹¬çœ¼å·¨é¹¿çœ¼çƒ å®ˆæŠ¤è€…ä¹‹è§’ èœ‚ç‹æµ† æ›¼å¾·æ‹‰è‰ é«˜è„šé¸Ÿè›‹ å­µåŒ–ä¸­çš„é«˜è„šé¸Ÿè›‹ æ ¼ç½—å§†çš„é»æ¶² æµ·å¸¦è¡¥ä¸ è±¡é¼»ã€å†¬è±¡é¼»
--   èƒ¡ä¹±åƒï¼ˆç©å®¶ï¼‰ï¼šæ³»æ ¹ç³–æµ†
--   èƒ¡ä¹±åƒï¼ˆåŠ¨ç‰©ï¼‰ï¼šä¼ç‰¹ç¾Šè‚‰å†» å½©è™¹ç³–è±† é²œæœå¯ä¸½é¥¼ é¾™è™¾æ­£é¤ åå¤«é¥¼ é»„æ²¹ å¤œè“
-- 2 éšæœºä¸‹é¥­èœæ¦‚ç‡å«è°ƒå‘³æ–™
-- 3 ç›´æ¥å›é¥¥é¥¿ç²¾ç¥å’Œè¡€é‡ï¼ˆé¿å…é£Ÿç‰©è®°å¿†ï¼‰+ 3.1 æ’é™¤è®°å¿†çš„æ–™ç†
-- 4 é˜Ÿå‹æ­»äº†çƒ¹é¥ªå››èœä¸€æ±¤ ï¼ˆå¼€å¸­ï¼‰ + 4.1 å¤æ´»é˜Ÿå‹

-- Section 2 åŠæˆå“é¢„åˆ¶èœ
-- 1 æ–™ç†åŒ…å‡†å¤‡ï¼ŒæŠŠ4ä¸ªé£Ÿææ‰“åŒ…èµ·æ¥ï¼Œå°±åƒçƒ¹é¥ªé”…ä¸€æ ·ï¼Œæ‰“åŒ…é£Ÿæå°±æ˜¯ä¸€ä¸ªä¸œè¥¿ï¼Œä¸å †å 
--    æ‰“åŒ…å¥½çš„æ–™ç†åŒ…ï¼Œå¯ä»¥ç›´æ¥æ”¾åœ¨ç«å †ä¸Šé¢åŠ çƒ­ï¼ˆæ§åˆ¶ç«å€™çš„äººä¸ä¼šå¤±è´¥ï¼‰ï¼Œçƒ§çƒ¤ä¸€æ¬¡æ‰1/40è€ä¹…ï¼Œç”Ÿæˆ1ä¸ªæ–™ç†
-- 2 æ–™ç†åŒ…å¯ä»¥åŒ…å«è°ƒå‘³æ–™
-- 3 æµæ°´çº¿ç”Ÿäº§å¯ä»¥è®©æ‰“åŒ…å¯ä»¥é¢å¤–äº§å‡ºä¸€äº›ï¼Œæ€»ä½¿ç”¨æ¬¡æ•°å¤§äº40
-- 4 å¿«é€Ÿé€è¾¾ï¼Œä¼šé£çš„çŒª


-- =========================================================
-- SECTION1 èƒ¡ä¹±æ–™ç†å…¨è¡¨ï¼ˆå«æ¢å¤ä¸æŠ›é”…æ¦‚ç‡ï¼‰
-- =========================================================
local spicedfoods = require("spicedfoods")

local FOOD_RECOVERY_TABLE = {

    -- èƒ¡ä¹±çƒ¹é¥ªï¼ˆé”…æ”¶è·è§¦å‘ï¼‰
    harvest_pot = {
        wetgoop        = { hunger = 15, sanity = 15, health = 15, throw_chance = 0.7 },
        powdercake     = { hunger = 10, sanity = 10, health = 10, throw_chance = 0.7 },
        monsterlasagna = { hunger = 30, sanity = 20, health = 15, throw_chance = 1.0 },
        monstertartare = { hunger = 25, sanity = 15, health = 10, throw_chance = 0.8 },
        mandrakesoup   = { hunger = 60, sanity = 60, health = 60, throw_chance = 1.0 },
    },

    -- èƒ¡ä¹±çƒ¤ï¼ˆç«å †ï¼‰
    cook_fire = {
        mandrake                 = { hunger = 150, sanity = 150, health = 150, throw_chance = 1.0 },
        ancientfruit_nightvision = { hunger = 20, sanity = 25, health = 10, throw_chance = 1.0 },
        tallbirdegg              = { hunger = 25, sanity = 10, health = 20, throw_chance = 1.0 },
        tallbirdegg_cracked      = { hunger = 20, sanity = 10, health = 20, throw_chance = 1.0 },
        red_cap                  = { hunger = 5, sanity = 5, health = 5, throw_chance = 0.2 },
        moon_cap                 = { hunger = 5, sanity = 5, health = 5, throw_chance = 0.2 },
        trunk_summer             = { hunger = 5, sanity = 5, health = 5, throw_chance = 0.8 },
        trunk_winter             = { hunger = 10, sanity = 10, health = 10, throw_chance = 1.0 },
        wobster_sheller_land     = { hunger = 75, sanity = 50, health = 20, throw_chance = 1.0 },
        oceanfish_small_8_inv    = { hunger = 75, sanity = 50, health = 20, throw_chance = 1.0 },
        oceanfish_small_7_inv    = { hunger = 75, sanity = 50, health = 20, throw_chance = 1.0 },
        oceanfish_small_6_inv    = { hunger = 75, sanity = 50, health = 20, throw_chance = 1.0 },
        oceanfish_medium_8_inv   = { hunger = 75, sanity = 50, health = 20, throw_chance = 1.0 },
        mole                     = { hunger = 15, sanity = 10, health = 10, throw_chance = 1.0 },
    },

    -- èƒ¡ä¹±åƒï¼ˆé€šç”¨ï¼‰
    eat_common = {
        deerclops_eyeball   = { hunger = 150, sanity = 150, health = 150, throw_chance = 1.0 },
        minotaurhorn        = { hunger = 150, sanity = 150, health = 150, throw_chance = 1.0 },
        royal_jelly         = { hunger = 20, sanity = 20, health = 15, throw_chance = 0.8 },
        mandrake            = { hunger = 150, sanity = 150, health = 150, throw_chance = 1.0 },
        tallbirdegg         = { hunger = 15, sanity = 15, health = 15, throw_chance = 0.7 },
        tallbirdegg_cracked = { hunger = 20, sanity = 25, health = 15, throw_chance = 0.9 },
        glommerfuel         = { hunger = 10, sanity = 15, health = 5, throw_chance = 0.7 },
        boatpatch_kelp      = { hunger = 5, sanity = 10, health = 5, throw_chance = 0.4 },
        trunk_summer        = { hunger = 20, sanity = 10, health = 10, throw_chance = 0.8 },
        trunk_winter        = { hunger = 25, sanity = 10, health = 15, throw_chance = 1.0 },
    },

    -- èƒ¡ä¹±åƒï¼ˆç©å®¶ï¼‰
    eat_player = {
        ipecacsyrup = { hunger = 15, sanity = 75, health = 10, throw_chance = 1.0 },
    },

    -- èƒ¡ä¹±åƒï¼ˆåŠ¨ç‰©ï¼‰
    eat_animal = {
        voltgoatjelly            = { hunger = 75, sanity = 75, health = 15, throw_chance = 1.0 },
        jellybean                = { hunger = 15, sanity = 15, health = 25, throw_chance = 0.4 },
        freshfruitcrepes         = { hunger = 75, sanity = 10, health = 15, throw_chance = 1.0 },
        lobsterdinner            = { hunger = 75, sanity = 15, health = 15, throw_chance = 1.0 },
        waffles                  = { hunger = 75, sanity = 10, health = 15, throw_chance = 1.0 },
        butter                   = { hunger = 75, sanity = 25, health = 20, throw_chance = 1.0 },
        ancientfruit_nightvision = { hunger = 10, sanity = 50, health = 10, throw_chance = 1.0 },
    },
}

-- è·å–åŸºç¡€é£Ÿç‰©åï¼ˆå»æ‰è°ƒå‘³å‰ç¼€ï¼‰
local function GetBaseFood(prefab)
    return spicedfoods[prefab] ~= nil and spicedfoods[prefab].basename or prefab
end

-- =========================================================
-- æŠ›é”…å‡½æ•°
-- =========================================================
local function SpawnCookPotFX(doer)
    if not doer then return end

    doer:DoTaskInTime(0.1, function()
        doer.AnimState:PlayAnimation("pyrocast")
    end)

    local x, y, z = doer.Transform:GetWorldPosition()
    local spawn_x, spawn_y, spawn_z
    local found = false
    for i = 1, 24 do
        local angle = math.random() * 2 * PI
        local tx = x + math.cos(angle) * math.random(1, 6)
        local tz = z + math.sin(angle) * math.random(1, 6)
        if TheWorld.Map:IsPassableAtPoint(tx, 0, tz) and not TheWorld.Map:IsOceanAtPoint(tx, 0, tz) then
            local nearby_fx = TheSim:FindEntities(tx, 0, tz, 3.5, { "FX", "improv_cookpot_fx" })
            if #nearby_fx == 0 then
                spawn_x, spawn_y, spawn_z = tx, 0, tz
                found = true
                break
            end
        end
    end
    if not found then spawn_x, spawn_y, spawn_z = x, 0, z end

    local fx = SpawnPrefab("lucy_transform_fx")
    fx.entity:SetParent(doer.entity)
    fx.entity:AddFollower()
    fx.Follower:FollowSymbol(doer.GUID, "hair", 0, 0, 0)

    local proj = SpawnPrefab("improv_cookpot_projectile_fx")
    proj.Transform:SetPosition(x, y, z)
    proj.components.complexprojectile:Launch(Vector3(spawn_x, spawn_y, spawn_z), doer)
end

local function ApplyTalking(inst, op)
    if op == "eat_common" then
        inst.components.talker:Say(GetString(inst, "ANNOUNCE_BAD_EAT_COMMOM"))
    elseif op == "eat_player" then
        inst.components.talker:Say(GetString(inst, "ANNOUNCE_BAD_EAT_BY_PLAYER"))
    elseif op == "eat_animal" then
        inst.components.talker:Say(GetString(inst, "ANNOUNCE_BAD_EAT_BY_ANIMAL"))
    elseif op == "cook_fire" then
        inst.components.talker:Say(GetString(inst, "ANNOUNCE_BAD_COOKS_FOOD"))
    elseif op == "harvest_pot" then
        inst.components.talker:Say(GetString(inst, "ANNOUNCE_BAD_HARVESTS_POT"))
    end
end

-- =========================================================
-- æ¢å¤å¤„ç†å‡½æ•°
-- =========================================================
local function ApplyRecovery(inst, doer, food_name, operation)
    if not inst or not inst.components or not food_name or not operation then return end

    local rec_table = FOOD_RECOVERY_TABLE[operation]
    if not rec_table or not rec_table[food_name] then return end

    local values = rec_table[food_name]

    -- éšæœºæµ®åŠ¨å›å¤
    local hunger_base = values.hunger or 0
    local sanity_base = values.sanity or 0
    local health_base = values.health or 0

    local hunger_variation = hunger_base * 0.2
    local sanity_variation = sanity_base * 0.2
    local health_variation = health_base * 0.2

    local hunger_delta = hunger_base + (math.random() * 2 - 1) * hunger_variation
    local sanity_delta = sanity_base + (math.random() * 2 - 1) * sanity_variation
    local health_delta = health_base + (math.random() * 2 - 1) * health_variation

    inst.components.hunger:DoDelta(hunger_delta)
    inst.components.sanity:DoDelta(sanity_delta)
    inst.components.health:DoDelta(health_delta)
end

-- =========================================================
-- æ²ƒåˆ©æ‰§è¡ŒåŠ¨ä½œ
-- =========================================================
local function doFunnyCook(inst, doer, food_name, op)
    if inst.prefab ~= "warly" then return end --æŠ€èƒ½æ ‘æ§åˆ¶

    local rec_table = FOOD_RECOVERY_TABLE[op]
    local values = rec_table and rec_table[food_name]
    if not values then return end

    -- æŠ›é”…ç‰¹æ•ˆæ¦‚ç‡æ§åˆ¶
    local chance = values.throw_chance or 1
    if math.random() < chance then
        SpawnCookPotFX(inst)
    end

    -- è¯´è¯é€»è¾‘
    ApplyTalking(inst, op)

    -- æ¢å¤é€»è¾‘
    ApplyRecovery(inst, doer, food_name, op) --æŠ€èƒ½æ ‘æ§åˆ¶

    -- puff ç‰¹æ•ˆ
    local puff = SpawnPrefab("small_puff")
    if puff then
        local x, y, z = inst.Transform:GetWorldPosition()
        puff.Transform:SetPosition(x, y, z)
    end
end

-- =========================================================
-- èƒ¡ä¹±çƒ¹é¥ªï¼ˆé”…æ”¶è·è§¦å‘ï¼‰
-- =========================================================
AddComponentPostInit("stewer", function(stewer)
    local old_Harvest = stewer.Harvest
    stewer.Harvest = function(self, harvester)
        local product = self.product
        local result = old_Harvest and old_Harvest(self, harvester)
        if product and FOOD_RECOVERY_TABLE.harvest_pot[product] then
            for _, player in ipairs(AllPlayers) do
                if player.prefab == "warly" and harvester and player:IsNear(harvester, 12) then
                    doFunnyCook(player, harvester, product, "harvest_pot")
                end
            end
        end
        return result
    end
end)

-- =========================================================
-- èƒ¡ä¹±çƒ¤ç›‘å¬
-- =========================================================
AddComponentPostInit("cookable", function(cookable)
    local old_Cook = cookable.Cook
    cookable.Cook = function(self, cooker, chef)
        local food_name = self.inst and self.inst.prefab or nil
        local product = old_Cook and old_Cook(self, cooker, chef)
        if food_name and FOOD_RECOVERY_TABLE.cook_fire[food_name] then
            for _, player in ipairs(AllPlayers) do
                if player.prefab == "warly" and chef and player:IsNear(chef, 12) then
                    doFunnyCook(player, chef, food_name, "cook_fire")
                end
            end
        end
        return product
    end
end)

-- =========================================================
-- èƒ¡ä¹±åƒç›‘å¬
-- =========================================================
AddComponentPostInit("edible", function(edible)
    local old_OnEaten = edible.OnEaten
    edible.OnEaten = function(self, eater)
        if old_OnEaten then old_OnEaten(self, eater) end

        local food_name = self.inst.prefab
        food_name = GetBaseFood(food_name)
        for _, player in ipairs(AllPlayers) do
            if player.prefab == "warly" and eater and player:IsNear(eater, 12) then
                local operation = nil

                if FOOD_RECOVERY_TABLE.eat_common[food_name] then
                    operation = "eat_common"
                elseif eater:HasTag("player") and FOOD_RECOVERY_TABLE.eat_player[food_name] then
                    operation = "eat_player"
                elseif not eater:HasTag("player") and FOOD_RECOVERY_TABLE.eat_animal[food_name] then
                    operation = "eat_animal"
                end

                if operation then
                    doFunnyCook(player, eater, food_name, operation)
                end
            end
        end
    end
end)


-- =========================================================
-- SECTION2 æ‰“åŒ…é¢„åˆ¶èœ
-- =========================================================
local containers = require("containers")
local params = containers.params
local cooking = require("cooking")
-- =========================================================
-- ğŸ± å››æ ¼æ‰“åŒ…è¢‹ prepack_foodbag_4
-- =========================================================
params.prepack_foodbag_4 = {
    widget =
    {
        slotpos =
        {
            Vector3(0, 64 + 32 + 8 + 4, 0),
            Vector3(0, 32 + 4, 0),
            Vector3(0, -(32 + 4), 0),
            Vector3(0, -(64 + 32 + 8 + 4), 0),
        },
        slotbg =
        {
            { image = "cook_slot_food.tex" },
            { image = "cook_slot_food.tex" },
            { image = "cook_slot_food.tex" },
            { image = "cook_slot_food.tex" },
        },
        animbank = "ui_cookpot_1x4",
        animbuild = "ui_cookpot_1x4",
        pos = Vector3(200, 0, 0),
        side_align_tip = 100,
        buttoninfo =
        {
            text = STRINGS.ACTIONS.COOK,
            position = Vector3(0, -165, 0),
        }
    },
    -- acceptsstacks = false,
    type = "cooker",
}

function params.prepack_foodbag_4.itemtestfn(container, item, slot)
    return cooking.IsCookingIngredient(item.prefab) and not container.inst:HasTag("burnt")
end

-- æŒ‰é’®é€»è¾‘ï¼šæ‰“åŒ…è§¦å‘çƒ¹é¥ª
function params.prepack_foodbag_4.widget.buttoninfo.fn(inst, doer)
    if inst.components.container ~= nil then
        -- æœåŠ¡å™¨ç«¯æ‰§è¡Œæ‰“åŒ…é€»è¾‘
        if inst.components.packagingstation ~= nil then
            inst.components.packagingstation:StartPackaging(doer)
        end
    elseif inst.replica.container ~= nil and not inst.replica.container:IsBusy() then
        SendRPCToServer(RPC.DoWidgetButtonAction, ACTIONS.COOK.code, inst, ACTIONS.COOK.mod_name)
    end
end

-- æŒ‰é’®æ˜¾ç¤ºæ¡ä»¶ï¼šå®¹å™¨æ»¡æ—¶æ‰æ˜¾ç¤º
function params.prepack_foodbag_4.widget.buttoninfo.validfn(inst)
    return inst.replica.container ~= nil and inst.replica.container:IsFull()
end

-- =========================================================
-- ğŸ± äº”æ ¼æ‰“åŒ…è¢‹ prepack_foodbag_5ï¼ˆç¬¬äº”æ ¼ä¸ºè°ƒå‘³æ–™ï¼‰
-- =========================================================
params.prepack_foodbag_5 = {
    widget =
    {
        slotpos =
        {
            -- å››æ ¼ç«–æ’ + ä¸€æ ¼è°ƒå‘³æ–™åå³æ”¾
            Vector3(0, 64 + 32 + 8 + 4, 0),
            Vector3(0, 32 + 4, 0),
            Vector3(0, -(32 + 4), 0),
            Vector3(0, -(64 + 32 + 8 + 4), 0),
            Vector3(64, -(64 + 32 + 8 + 4), 0), -- è°ƒå‘³æ–™æ ¼
        },
        slotbg =
        {
            { image = "cook_slot_food.tex" },
            { image = "cook_slot_food.tex" },
            { image = "cook_slot_food.tex" },
            { image = "cook_slot_food.tex" },
            { image = "cook_slot_spice.tex" },
        },
        animbank = "ui_cookpot_1x4",
        animbuild = "ui_cookpot_1x4",
        pos = Vector3(200, 0, 0),
        side_align_tip = 100,
        buttoninfo =
        {
            text = STRINGS.ACTIONS.COOK,
            position = Vector3(0, -165, 0),
        },
    },
    -- acceptsstacks = false,
    type = "cooker",
}

function params.prepack_foodbag_5.itemtestfn(container, item, slot)
    return item
        and not container.inst:HasTag("burnt")
        and (
            (slot ~= nil and slot < 5 and cooking.IsCookingIngredient(item.prefab))
            or (slot == 5 and (((item.prefab or ""):find("^spice_") ~= nil) or item:HasTag("spice")))
            or (slot == nil and (cooking.IsCookingIngredient(item.prefab) or ((item.prefab or ""):find("^spice_") ~= nil) or item:HasTag("spice")))
        )
end

-- æŒ‰é’®é€»è¾‘ï¼šæ‰“åŒ…è§¦å‘çƒ¹é¥ª
function params.prepack_foodbag_5.widget.buttoninfo.fn(inst, doer)
    if inst.components.container ~= nil then
        BufferedAction(doer, inst, ACTIONS.COOK):Do()
    elseif inst.replica.container ~= nil and not inst.replica.container:IsBusy() then
        SendRPCToServer(RPC.DoWidgetButtonAction, nil, inst, nil)
    end
end

-- æŒ‰é’®æ˜¾ç¤ºæ¡ä»¶ï¼šå®¹å™¨æ»¡æ—¶æ‰æ˜¾ç¤º
function params.prepack_foodbag_5.widget.buttoninfo.validfn(inst)
    return inst.replica.container ~= nil and inst.replica.container:IsFull()
end

-- æ›´æ–°æœ€å¤§æ ¼å­æ•°é‡
containers.MAXITEMSLOTS = math.max(containers.MAXITEMSLOTS, 5)
