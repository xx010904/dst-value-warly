-- å¨è‰ºï¼ˆè§£å†³è·å–æ–™ç†è°ƒæ–™éš¾ï¼‰
-- æ‹¥æœ‰ç²¾æ¹›å¨è‰ºçš„å¨å¸ˆå¹¶ä¸ä¾èµ–ç‚Šå…·ï¼Œç”šè‡³ä¸ä¾èµ–é£Ÿæï¼Œéšæ—¶éšåœ°å³å…´å‘æŒ¥åšå‡ºä¸€æ¡Œå¥½èœ
-- Section 1ï¼šä¸‹é¥­æ“ä½œ Meal-worthy Play
-- 1 â€œæ²ƒåˆ©çœ‹åˆ°åˆ«äººåšå‡ºåƒåœ¾æ–™ç†æ—¶ï¼Œè¢«æ¿€å‘å¨å¸ˆçµé­‚ï¼Œåšå‡ºä¸‹é¥­èœâ€ï¼Œå±•ç¤ºå¨è‰ºï¼Œå½“åœºè·Ÿé™ªä¸€ä»½ä¸‹é¥­èœï¼šå°±åœ°è‡ªåŠ¨çƒ¹é¥ªä¸€ä»½éšæœºä¸‹é¥­èœ
--   èƒ¡ä¹±çƒ¹é¥ªï¼šæ½®æ¹¿é»ç³Šï¼Œç²‰æœ«è›‹ç³•ï¼Œæ€ªç‰©åƒå±‚é¥¼ï¼Œæ€ªç‰©é‘é¼ï¼Œæ›¼å¾·æ‹‰è‰æ±¤
--   èƒ¡ä¹±çƒ¤ï¼šæ›¼å¾·æ‹‰è‰ å¤œè“ é«˜è„šé¸Ÿè›‹ å­µåŒ–ä¸­çš„é«˜è„šé¸Ÿè›‹ çº¢è˜‘è‡ æœˆäº®è˜‘è‡ è±¡é¼»ã€å†¬è±¡é¼» é¾™è™¾ 4ç§å­£èŠ‚é±¼ é¼¹é¼ 
--   èƒ¡ä¹±åƒï¼ˆé€šç”¨ï¼‰ï¼šç‹¬çœ¼å·¨é¹¿çœ¼çƒ å®ˆæŠ¤è€…ä¹‹è§’ èœ‚ç‹æµ† æ›¼å¾·æ‹‰è‰ é«˜è„šé¸Ÿè›‹ å­µåŒ–ä¸­çš„é«˜è„šé¸Ÿè›‹ æ ¼ç½—å§†çš„é»æ¶² æµ·å¸¦è¡¥ä¸ è±¡é¼»ã€å†¬è±¡é¼»
--   èƒ¡ä¹±åƒï¼ˆç©å®¶ï¼‰ï¼šæ³»æ ¹ç³–æµ†
--   èƒ¡ä¹±åƒï¼ˆåŠ¨ç‰©ï¼‰ï¼šä¼ç‰¹ç¾Šè‚‰å†» å½©è™¹ç³–è±† é²œæœå¯ä¸½é¥¼ é¾™è™¾æ­£é¤ åå¤«é¥¼ é»„æ²¹ å¤œè“
-- 2 è‡ªç§å›å¤åŠ å¼ºï¼šç›´æ¥å›é¥¥é¥¿ç²¾ç¥å’Œè¡€é‡ï¼ˆé¿å…é£Ÿç‰©è®°å¿†ï¼‰+ 3.1 æ’é™¤è®°å¿†çš„æ–™ç†
-- 3 å›¢é˜Ÿå›å¤åŠ å¼ºï¼šé˜Ÿå‹æ­»äº†çƒ¹é¥ªå››èœä¸€æ±¤ ï¼ˆå¼€å¸­ï¼‰ + 4.1 æœ‰ä¸€é“èœæ˜¯æ¯’èœï¼Œåƒäº†çš„äººè´¡çŒ®è‡ªå·±çš„ç”Ÿå‘½åŠ›å¤æ´»æ­»è€…
-- 4 éšæœºä¸‹é¥­èœæ¦‚ç‡å«è°ƒå‘³æ–™
-- æ–°ç‰ˆ
-- 1 ä¸‹é¥­æ“ä½œ
-- 2 å¼€å¸­
-- 3 å–œæ–°åŒæ—§ åœ¨çƒ¹é¥ªä¸‹é¥­èœæ—¶ï¼Œæ²ƒåˆ©ä¼šè¿›è¡Œä¸€æ¬¡â€œè¯•å‘³â€ï¼Œç•¥å¾®æ¢å¤ä¸‰ç»´ã€‚ è‹¥å³å°†äº§å‡ºçš„èœè‚´å­˜åœ¨äºä»–çš„é£Ÿç‰©è®°å¿†ä¸­ï¼Œå°†è‡ªåŠ¨è½¬åŒ–ä¸ºéšæœºæœªçŸ¥æ–™ç†ã€‚
-- 4 æ›´åŠ ä¸‹é¥­

-- Section 2ï¼šç”»å¤§é¥¼
-- 1 æ²ƒåˆ©ä»…ä»…éœ€è¦ä»‹ç»ä¸€ä¸‹ä»–çš„å¨è‰ºï¼Œä¾¿å¯è®©å¤§å®¶é¥±è…¹ã€‚é”…æ£€æµ‹åˆ°é™„è¿‘æœ‰ä¸‰ç»´ä¸æ»¡çš„é˜Ÿå‹ï¼Œå³é”®ç‚¹å‡»é”…ç›´æ¥è¡¥ï¼Œç„¶åæ…¢æ…¢æ¶ˆè€—
-- 2 æ²ƒåˆ©å¯ä»¥æ‰‹æ“å¤§é¥¼ã€‚åƒäº†å¤§é¥¼æ•ˆæœåŒé”…è¡¥ï¼ˆç»™å¯„å±…èŸ¹ï¼‰
-- 3 å¤§é¥¼å¯ä»¥çƒ¤è€Œä¸æ˜¯å˜æˆç°çƒ¬
-- 4 ç°çƒ¤å¤§é¥¼å˜æˆé™„è¿‘ç©å®¶æœ€å–œæ¬¢çš„é£Ÿç‰©ï¼Œæˆ–è€…é£é¥¼

-- Section 3
-- 1 çœŸé¦™è­¦å‘Šï¼šå¯ä»¥å–‚è§£è¯»æŒ‘é£Ÿè§’è‰²é£Ÿç‰©
-- 2 çœŸé¦™è­¦å‘Šï¼šå¯ä»¥å–‚å…¶ä»–è§’è‰²è…çƒ‚ç‰©


-- =========================================================
-- SECTION1 èƒ¡ä¹±æ–™ç†å…¨è¡¨ï¼ˆå«æ¢å¤ä¸æŠ›é”…æ¦‚ç‡ï¼‰
-- =========================================================
local spicedfoods = require("spicedfoods")

local FOOD_RECOVERY_TABLE = {

    -- èƒ¡ä¹±çƒ¹é¥ªï¼ˆé”…æ”¶è·è§¦å‘ï¼‰ä¸€ä¸ªåƒåœ¾æ–™ç†æ¢ä¸€ä¸ªéšæœºæ–™ç†
    harvest_pot = {
        wetgoop        = { hunger = 15, sanity = 15, health = 15, throw_chance = 0.7 },
        powdercake     = { hunger = 10, sanity = 10, health = 10, throw_chance = 0.7 },
        monsterlasagna = { hunger = 30, sanity = 20, health = 15, throw_chance = 1.0 },
        monstertartare = { hunger = 25, sanity = 15, health = 10, throw_chance = 0.8 },
        mandrakesoup   = { hunger = 60, sanity = 60, health = 60, throw_chance = 1.0 },
    },

    -- èƒ¡ä¹±çƒ¤ï¼ˆç«å †ï¼‰ä¸€ä¸ªé£Ÿææ¢ä¸€ä¸ªéšæœºæ–™ç†
    cook_fire = {
        mandrake                 = { hunger = 25, sanity = 25, health = 25, throw_chance = 1.0 },
        ancientfruit_nightvision = { hunger = 5, sanity = 5, health = 5, throw_chance = 0.6 },
        tallbirdegg              = { hunger = 15, sanity = 5, health = 20, throw_chance = 0.4 },
        tallbirdegg_cracked      = { hunger = 15, sanity = 5, health = 20, throw_chance = 0.4 },
        red_cap                  = { hunger = 5, sanity = 1, health = 5, throw_chance = 0.1 },
        moon_cap                 = { hunger = 5, sanity = 1, health = 5, throw_chance = 0.1 },
        trunk_summer             = { hunger = 5, sanity = 5, health = 5, throw_chance = 0.4 },
        trunk_winter             = { hunger = 5, sanity = 5, health = 5, throw_chance = 0.5 },
        wobster_sheller_land     = { hunger = 15, sanity = 15, health = 15, throw_chance = 0.5 },
        oceanfish_small_8_inv    = { hunger = 15, sanity = 15, health = 15, throw_chance = 0.5 },
        oceanfish_small_7_inv    = { hunger = 15, sanity = 15, health = 15, throw_chance = 0.5 },
        oceanfish_small_6_inv    = { hunger = 15, sanity = 15, health = 15, throw_chance = 0.5 },
        oceanfish_medium_8_inv   = { hunger = 15, sanity = 15, health = 15, throw_chance = 0.5 },
        mole                     = { hunger = 15, sanity = 10, health = 10, throw_chance = 0.3 },
    },

    -- èƒ¡ä¹±åƒï¼ˆé€šç”¨ï¼‰ä¸€ä¸ªé£Ÿææ¢ä¸€ä¸ªéšæœºæ–™ç†
    eat_common = {
        deerclops_eyeball   = { hunger = 150, sanity = 150, health = 150, throw_chance = 1.0 },
        minotaurhorn        = { hunger = 150, sanity = 150, health = 150, throw_chance = 1.0 },
        royal_jelly         = { hunger = 20, sanity = 20, health = 15, throw_chance = 0.4 },
        mandrake            = { hunger = 25, sanity = 25, health = 25, throw_chance = 1.0 },
        tallbirdegg         = { hunger = 15, sanity = 15, health = 15, throw_chance = 0.4 },
        tallbirdegg_cracked = { hunger = 20, sanity = 25, health = 15, throw_chance = 0.5 },
        glommerfuel         = { hunger = 10, sanity = 15, health = 5, throw_chance = 0.7 },
        boatpatch_kelp      = { hunger = 5, sanity = 10, health = 5, throw_chance = 0.4 },
        trunk_summer        = { hunger = 20, sanity = 10, health = 10, throw_chance = 0.4 },
        trunk_winter        = { hunger = 25, sanity = 10, health = 15, throw_chance = 0.5 },
    },

    -- èƒ¡ä¹±åƒï¼ˆç©å®¶ï¼‰ä¸€ä¸ªé£Ÿææ¢ä¸€ä¸ªéšæœºæ–™ç†
    eat_player = {
        ipecacsyrup = { hunger = 33, sanity = 33, health = 33, throw_chance = 1.0 },
    },

    -- èƒ¡ä¹±åƒï¼ˆåŠ¨ç‰©ï¼‰ä¸€ä¸ªæ–™ç†æ¢ä¸€ä¸ªéšæœºæ–™ç†
    eat_animal = {
        voltgoatjelly            = { hunger = 15, sanity = 25, health = 15, throw_chance = 1.0 },
        jellybean                = { hunger = 25, sanity = 15, health = 25, throw_chance = 0.4 },
        freshfruitcrepes         = { hunger = 25, sanity = 10, health = 15, throw_chance = 1.0 },
        lobsterdinner            = { hunger = 25, sanity = 15, health = 15, throw_chance = 1.0 },
        waffles                  = { hunger = 25, sanity = 10, health = 15, throw_chance = 1.0 },
        butter                   = { hunger = 15, sanity = 25, health = 20, throw_chance = 1.0 },
        ancientfruit_nightvision = { hunger = 5, sanity = 5, health = 5, throw_chance = 0.6 },
    },
}

-- ä¿å­˜æ²ƒåˆ©æŠ›é”…å’Œçƒ¤é¥¼çš„ç´¯è®¡æ¦‚ç‡
AddPlayerPostInit(function(inst)
    if not TheWorld.ismastersim then
        return
    end

    -- åªå¯¹æ²ƒåˆ©ç”Ÿæ•ˆ
    if inst.prefab ~= "warly" then
        return
    end

    inst.warly_throw_pot_accum_chance = inst.warly_throw_pot_accum_chance or 0
    inst.warly_skypie_accum_chance = inst.warly_skypie_accum_chance or 0

    local _OldOnSave_throw = inst.OnSave
    inst.OnSave = function(inst, data)
        if _OldOnSave_throw then
            _OldOnSave_throw(inst, data)
        end
        data.throw_accumulator = inst.warly_throw_pot_accum_chance
        data.warly_skypie_accum_chance = inst.warly_skypie_accum_chance
    end

    local _OldOnLoad_throw = inst.OnLoad
    inst.OnLoad = function(inst, data)
        if _OldOnLoad_throw then
            _OldOnLoad_throw(inst, data)
        end
        if data and data.throw_accumulator then
            inst.warly_throw_pot_accum_chance = data.throw_accumulator
        end
        if data and data.warly_skypie_accum_chance then
            inst.warly_skypie_accum_chance = data.warly_skypie_accum_chance
        end
    end
end)

-- è·å–åŸºç¡€é£Ÿç‰©åï¼ˆå»æ‰è°ƒå‘³å‰ç¼€/åç¼€ï¼‰ï¼Œæ›´ç¨³å¥åœ°å¤„ç† spicedfoods[prefab] å­˜åœ¨ä½† .basename ä¸ºç©ºçš„æƒ…å†µ
local function GetBaseFood(prefab)
    if not prefab then return prefab end

    -- ä¼˜å…ˆä½¿ç”¨ spicedfoods è¡¨é‡Œçš„ basename
    local info = spicedfoods[prefab]
    if info and info.basename and type(info.basename) == "string" and info.basename ~= "" then
        return info.basename
    end

    -- å°è¯•åŒ¹é… "_spice_" åŠå…¶åæ‰€æœ‰å†…å®¹ä¸ºè°ƒå‘³åç¼€
    -- ä¾‹ï¼škoalefig_trunk_spice_jelly -> koalefig_trunk
    --     frogfishbowl_spice_mandrake_jam -> frogfishbowl
    local base = prefab:gsub("_spice_.+$", "")
    if base ~= prefab then
        return base
    end

    return prefab
end

-- =========================================================
-- æŠ›é”…å‡½æ•°
-- =========================================================
local function SpawnCookPotFX(chef, idiot, meal)
    if not chef then return end

    chef:DoTaskInTime(0.1, function()
        chef.AnimState:PlayAnimation("pyrocast")
    end)

    local x, y, z = chef.Transform:GetWorldPosition()
    local spawn_x, spawn_y, spawn_z = idiot.Transform:GetWorldPosition()

    local fx = SpawnPrefab("lucy_transform_fx")
    fx.entity:SetParent(chef.entity)
    fx.entity:AddFollower()
    fx.Follower:FollowSymbol(chef.GUID, "hair", 0, 0, 0)

    local proj = SpawnPrefab("improv_cookpot_projectile_fx")
    proj.doer = chef
    proj.meal = meal
    proj.Transform:SetPosition(x, y, z)
    proj.components.complexprojectile:Launch(Vector3(spawn_x, spawn_y, spawn_z), chef)
end

local function ApplyTalking(inst, op)
    if op == "eat_common" then
        inst.components.talker:Say(GetString(inst, "ANNOUNCE_BAD_EAT_COMMOM"))
    elseif op == "eat_player" then
        inst.components.talker:Say(GetString(inst, "ANNOUNCE_BAD_EAT_BY_PLAYER"))
    elseif op == "eat_animal" then
        inst.components.talker:Say(GetString(inst, "ANNOUNCE_BAD_EAT_BY_ANIMAL"))
    elseif op == "cook_fire" then
        inst.components.talker:Say(GetString(inst, "ANNOUNCE_BAD_COOKS_FOOD"))
    elseif op == "harvest_pot" then
        inst.components.talker:Say(GetString(inst, "ANNOUNCE_BAD_HARVESTS_POT"))
    end
end

-- =========================================================
-- æ¢å¤å¤„ç†å‡½æ•°
-- =========================================================
local function ApplyRecovery(inst, idiot, food_name, operation)
    if not inst or not inst.components or not food_name or not operation then return end

    local rec_table = FOOD_RECOVERY_TABLE[operation]
    if not rec_table or not rec_table[food_name] then return end

    local values = rec_table[food_name]

    -- éšæœºæµ®åŠ¨å›å¤
    local hunger_base = values.hunger or 0
    local sanity_base = values.sanity or 0
    local health_base = values.health or 0

    local hunger_variation = hunger_base * 0.2
    local sanity_variation = sanity_base * 0.2
    local health_variation = health_base * 0.2

    local hunger_delta = hunger_base + (math.random() * 2 - 1) * hunger_variation
    local sanity_delta = sanity_base + (math.random() * 2 - 1) * sanity_variation
    local health_delta = health_base + (math.random() * 2 - 1) * health_variation

    inst.components.hunger:DoDelta(hunger_delta)
    inst.components.sanity:DoDelta(sanity_delta)
    inst.components.health:DoDelta(health_delta)
end

-- =========================================================
-- æ²ƒåˆ©æ‰§è¡ŒåŠ¨ä½œ
-- =========================================================
local function doFunnyCook(inst, idiot, food_name, op)
    local rec_table = FOOD_RECOVERY_TABLE[op]
    local values = rec_table and rec_table[food_name]
    if not values then return end

    -- pingä¸ªé—®å·â“
    local playerMark = SpawnPrefab("improv_question_mark_fx")
    playerMark.entity:SetParent(inst.entity)
    playerMark.Transform:SetPosition(0, 3, 0)
    local idiotMark = SpawnPrefab("improv_question_mark_fx")
    idiotMark.entity:SetParent(idiot.entity)
    idiotMark.Transform:SetPosition(0, 3, 0)

    -- æŠ›é”…ç‰¹æ•ˆæ¦‚ç‡æ§åˆ¶
    inst.warly_throw_pot_accum_chance = inst.warly_throw_pot_accum_chance or 0
    -- åŸºç¡€æ¦‚ç‡
    local base_chance = values.throw_chance or 1
    -- éšæœºæµ®åŠ¨èŒƒå›´
    local min_mult = 0.8
    local max_mult = 1.2
    -- ç”Ÿæˆä¸€æ¬¡éšæœºæµ®åŠ¨å€¼
    local chance = base_chance * (math.random() * (max_mult - min_mult) + min_mult)
    inst.warly_throw_pot_accum_chance = inst.warly_throw_pot_accum_chance + chance
    while inst.warly_throw_pot_accum_chance >= 1 do
        inst.warly_throw_pot_accum_chance = inst.warly_throw_pot_accum_chance - 1

        inst:DoTaskInTime(0.5, function(inst)
            if inst and inst:IsValid() then
                SpawnCookPotFX(inst, idiot)
                -- puff ç‰¹æ•ˆ
                local puff = SpawnPrefab("warly_sky_pie_cook_fx")
                if puff then
                    puff.entity:SetParent(inst.entity)
                    puff.Transform:SetPosition(0, 1, 0)
                end
            end
        end)
    end

    -- è¯´è¯é€»è¾‘
    ApplyTalking(inst, op)

    -- æ¢å¤é€»è¾‘
    ApplyRecovery(inst, idiot, food_name, op)
end

-- =========================================================
-- èƒ¡ä¹±çƒ¹é¥ªï¼ˆé”…æ”¶è·è§¦å‘ï¼‰
-- =========================================================
AddComponentPostInit("stewer", function(stewer)
    local old_Harvest = stewer.Harvest
    stewer.Harvest = function(self, harvester)
        local product = self.product
        local result = old_Harvest and old_Harvest(self, harvester)
        if product and FOOD_RECOVERY_TABLE.harvest_pot[product] then
            for _, player in ipairs(AllPlayers) do
                if player.prefab == "warly" and player.components.health and not player.components.health:IsDead() then
                    if harvester and player:IsNear(harvester, 12) then
                        local hasSkill = player.components.skilltreeupdater and
                            player.components.skilltreeupdater:IsActivated("warly_funny_cook_base")
                        if hasSkill then
                            doFunnyCook(player, harvester, product, "harvest_pot")
                            break
                        end
                    end
                end
            end
        end
        return result
    end
end)

-- =========================================================
-- èƒ¡ä¹±çƒ¤ç›‘å¬
-- =========================================================
AddComponentPostInit("cookable", function(cookable)
    local old_Cook = cookable.Cook
    cookable.Cook = function(self, cooker, chef)
        local food_name = self.inst and self.inst.prefab or nil
        local product = old_Cook and old_Cook(self, cooker, chef)
        if food_name and FOOD_RECOVERY_TABLE.cook_fire[food_name] then
            for _, player in ipairs(AllPlayers) do
                if player.prefab == "warly" and player.components.health and not player.components.health:IsDead() then
                    if chef and player:IsNear(chef, 12) then
                        local hasSkill = player.components.skilltreeupdater and
                            player.components.skilltreeupdater:IsActivated("warly_funny_cook_base")
                        if hasSkill then
                            doFunnyCook(player, chef, food_name, "cook_fire")
                            break
                        end
                    end
                end
            end
        end
        return product
    end
end)

-- =========================================================
-- èƒ¡ä¹±åƒç›‘å¬
-- =========================================================
AddComponentPostInit("edible", function(edible)
    local old_OnEaten = edible.OnEaten
    edible.OnEaten = function(self, eater)
        if old_OnEaten then old_OnEaten(self, eater) end
        if not self.inst:HasTag("dummyfood") then
            local food_name = self.inst.prefab
            food_name = GetBaseFood(food_name)
            for _, player in ipairs(AllPlayers) do
                if player.prefab == "warly" and player.components.health and not player.components.health:IsDead() then
                    if eater and player:IsNear(eater, 12) then
                        local hasSkill = player.components.skilltreeupdater and
                            player.components.skilltreeupdater:IsActivated("warly_funny_cook_base")
                        if hasSkill then
                            local operation = nil

                            if FOOD_RECOVERY_TABLE.eat_common[food_name] then
                                operation = "eat_common"
                            elseif eater:HasTag("player") and FOOD_RECOVERY_TABLE.eat_player[food_name] then
                                operation = "eat_player"
                            elseif not eater:HasTag("player") and FOOD_RECOVERY_TABLE.eat_animal[food_name] then
                                operation = "eat_animal"
                            end

                            if operation then
                                doFunnyCook(player, eater, food_name, operation)
                                break
                            end
                        end
                    end
                end
            end
        end
    end
end)

-- =========================================================
-- æ­»äº¡ç›‘å¬å¼€å¸­
-- =========================================================
AddPlayerPostInit(function(dead)
    if not TheWorld.ismastersim then
        return
    end
    -- ç›‘å¬ç©å®¶æ­»äº¡äº‹ä»¶
    dead:ListenForEvent("death", function(inst, data)
        -- éå†æ‰€æœ‰ç©å®¶ï¼Œæ‰¾é™„è¿‘çš„æ²ƒåˆ©
        for _, player in ipairs(AllPlayers) do
            if player.prefab == "warly" and player.components.health and not player.components.health:IsDead()
                and dead and player:IsNear(dead, 12)
            then
                -- æŠ€èƒ½æ ‘æ§åˆ¶
                local hasSkill = player.components.skilltreeupdater and
                    player.components.skilltreeupdater:IsActivated("warly_funny_cook_feast")
                if hasSkill then
                    -- æ²ƒåˆ©å‘ç°é˜Ÿå‹å»ä¸–ï¼Œå“€æ‚¼ + çŒ®ä¸Šâ€œå››èœä¸€æ±¤â€
                    -- æ‰“å‡ºé—®å·ç‰¹æ•ˆâ“
                    local dead_fx = SpawnPrefab("improv_question_mark_fx")
                    if dead_fx then
                        dead_fx.entity:SetParent(dead.entity)
                        dead_fx.Transform:SetPosition(0, 3, 0)
                    end
                    local warly_fx = SpawnPrefab("improv_question_mark_fx")
                    if warly_fx then
                        warly_fx.entity:SetParent(player.entity)
                        warly_fx.Transform:SetPosition(0, 3, 0)
                    end

                    -- èœè°±é¡ºåº
                    local dishes = { "ratatouille_spice_chili", "ratatouille_spice_garlic", "ratatouille_spice_salt",
                        "ratatouille_spice_sugar", "bonesoup" }

                    -- é€ä¸ªç”Ÿæˆç‰¹æ•ˆï¼ˆæ¯0.25ç§’ï¼‰
                    for i, prefab in ipairs(dishes) do
                        player:DoTaskInTime((i - 1) * 0.25, function()
                            if player:IsValid() and dead:IsValid() then
                                SpawnCookPotFX(player, dead, prefab)
                            end
                        end)
                    end
                end
            end
        end
    end, dead)
end)


-- =========================================================
-- SECTION2 å¯ä»¥å³é”®ç‚¹å‡»åŠ¨ä½œâ€œç”»é¥¼â€çš„é”…
-- =========================================================
-- ----------------------------------------------------------
-- å®šä¹‰æ²ƒåˆ©ä¸“å±çš„warly_sky_pieé…æ–¹
-- ----------------------------------------------------------
AddRecipe2("warly_sky_pie",
    {
        Ingredient("portablecookpot_item", 0),
        Ingredient(CHARACTER_INGREDIENT.SANITY, 30)
    },
    TECH.NONE,
    {
        product = "warly_sky_pie",
        atlas = "images/inventoryimages/warly_sky_pie.xml",
        image = "warly_sky_pie.tex",
        builder_tag = "masterchef",           -- ä»…æ²ƒåˆ©å¯åš
        builder_skill = "warly_sky_pie_make", -- æŒ‡å®šæŠ€èƒ½æ ‘æ‰èƒ½åš
        description = "warly_sky_pie",
        numtogive = 3,
        no_deconstruction = true, -- å¯é€‰ï¼šé˜²æ­¢åˆ†è§£è¿˜åŸ
        sg_state = "spawn_warly_sky_pie"
    }
)

-- æ·»åŠ åˆ°è§’è‰²ä¸“å±æ ‡ç­¾é¡µ
AddRecipeToFilter("warly_sky_pie", "CHARACTER")

-- ----------------------------------------------------------
-- å¯ä»¥å³é”®ç‚¹å‡»åŠ¨ä½œâ€œç”»é¥¼â€çš„é”…
-- ----------------------------------------------------------
-- 1) Hook portablecookpot_item prefabï¼Œæœ¬ä½“é€»è¾‘ï¼šæ‰«æã€æ¿€æ´»æ ‡å¿—ã€æç¤º
AddPrefabPostInit("portablecookpot_item", function(inst)
    if not TheWorld.ismastersim then
        return
    end

    inst:AddComponent("skypieinspiretool")

    -- å†…éƒ¨å‡½æ•°ï¼šå¯åŠ¨ / åœæ­¢ æ£€æµ‹ä»»åŠ¡
    local function StartDetection(inst)
        if inst._detect_task == nil then
            inst._detect_task = inst:DoPeriodicTask(1, function()
                local owner = inst.components.inventoryitem and inst.components.inventoryitem.owner
                if not (owner and owner:IsValid()) then
                    inst:RemoveTag("active_pot_pie")
                    inst.pie_target = nil
                    if inst.components.inventoryitem then
                        inst.components.inventoryitem.imagename = "portablecookpot_item"
                        inst.components.inventoryitem.atlasname = "images/inventoryimages2.xml"
                    end
                    return
                end

                -- ä»¥æŒæœ‰è€…ä¸ºä¸­å¿ƒæ£€æµ‹é™„è¿‘ç©å®¶
                local x, y, z = owner.Transform:GetWorldPosition()
                local players = TheSim:FindEntities(x, y, z, 10, { "player" }, { "playerghost" })

                local should_activate = false
                for _, p in ipairs(players) do
                    if p and p:IsValid() and p.prefab ~= "warly" and not p:HasDebuff("warly_sky_pie_inspire_buff") then
                        if (p.components.hunger and p.components.hunger:GetPercent() < 0.5)
                            or (p.components.sanity and p.components.sanity:GetPercent() < 0.5)
                            or (p.components.health and p.components.health:GetPercent() < 0.5) then
                            should_activate = true
                            inst.pie_target = p
                            break
                        end
                    end
                end

                if should_activate then
                    if not inst:HasTag("active_pot_pie") then
                        inst:AddTag("active_pot_pie")
                        if inst.components.inventoryitem then
                            inst.components.inventoryitem.imagename = "portablecookpot_item_actived"
                            inst.components.inventoryitem.atlasname =
                            "images/inventoryimages/portablecookpot_item_actived.xml"
                        end
                        if owner.components.talker then
                            owner.components.talker:Say(GetString(owner, "ANNOUNCE_NEED_PIE"))
                        end
                    end
                else
                    if inst:HasTag("active_pot_pie") then
                        inst:RemoveTag("active_pot_pie")
                        inst.pie_target = nil
                        if inst.components.inventoryitem then
                            inst.components.inventoryitem.imagename = "portablecookpot_item"
                            inst.components.inventoryitem.atlasname = "images/inventoryimages2.xml"
                        end
                    end
                end
            end)
        end
    end

    local function StopDetection(inst)
        if inst._detect_task ~= nil then
            inst._detect_task:Cancel()
            inst._detect_task = nil
        end
        inst:RemoveTag("active_pot_pie")
        inst.pie_target = nil
        if inst.components.inventoryitem then
            inst.components.inventoryitem.imagename = "portablecookpot_item"
            inst.components.inventoryitem.atlasname = "images/inventoryimages2.xml"
        end
    end

    -- ç›‘å¬ç‰©å“æ‹¾å– / ä¸¢å¼ƒ
    inst:ListenForEvent("onputininventory", function(inst, owner)
        local hasSkill = owner and owner:HasTag("warly_sky_pie_pot")
        if hasSkill and owner:HasTag("player") then
            StartDetection(inst)
        else
            StopDetection(inst)
        end
    end)

    inst:ListenForEvent("ondropped", function(inst)
        StopDetection(inst)
    end)

    -- å¦‚æœç”Ÿæˆæ—¶å°±åœ¨ç©å®¶èº«ä¸Šï¼Œç›´æ¥å¯åŠ¨æ£€æµ‹
    inst:DoTaskInTime(60, function()
        local owner = inst.components.inventoryitem and inst.components.inventoryitem.owner
        local hasSkill = owner and owner:HasTag("warly_sky_pie_pot")
        -- print("ç”»é¥¼çš„é”…æ˜¯å¦æ¿€æ´»ï¼š", hasSkill)
        if hasSkill and owner:HasTag("player") then
            StartDetection(inst)
        end
    end)

    inst.StartDetection = StartDetection
    inst.StopDetection = StopDetection
end)

-- 2) å®šä¹‰è‡ªå®šä¹‰ Action
local ACTIVATE_POT_PIE = AddAction("ACTIVATE_POT_PIE", STRINGS.ACTIONS.ACTIVATE_POT_PIE, function(act)
    if not act or not act.doer then
        return
    end

    local inst = act.invobject -- èƒŒåŒ…é‡Œçš„ç‰©å“
    local doer = act.doer

    local hasSkill = doer and doer:HasTag("warly_sky_pie_pot") -- æŠ€èƒ½æ ‘æ§åˆ¶
    if not hasSkill then
        return
    end

    if not inst or not inst:IsValid() or not doer or not doer:IsValid() then
        return
    end

    -- æ£€æŸ¥æ¿€æ´»ä¸å†·å´æ ‡å¿—ï¼ˆä»¥é˜²ä¸‡ä¸€ï¼‰
    local target = inst.pie_target
    if not inst:HasTag("active_pot_pie") or target == nil then
        if doer.components.talker then
            doer.components.talker:Say("It's a bug.")
        end
        return
    end

    -- ç»™æŒæœ‰è€…æ·»åŠ  debuffï¼ˆbuffï¼‰
    if target:HasDebuff("warly_sky_pie_inspire_buff") then
        return
    else
        target:AddDebuff("warly_sky_pie_inspire_buff", "warly_sky_pie_inspire_buff")
    end

    -- æ•ˆæœï¼šåŠ¨ç”»
    if target.components.inventory:IsHeavyLifting() and not target.components.rider:IsRiding() then
        target.AnimState:PlayAnimation("heavy_eat")
    else
        target.AnimState:PlayAnimation("eat_pre")
        target.AnimState:PushAnimation("eat", false)
    end

    -- æ•ˆæœï¼šéŸ³æ•ˆ/ç‰¹æ•ˆ/å°è¯
    if target.SoundEmitter then
        target.SoundEmitter:PlaySound("dontstarve/common/cookingpot_finish")
    end

    if target.components.talker then
        target.components.talker:Say(GetString(target, "ANNOUNCE_EAT_PIE"))
    end

    -- ç‰©å“ä¸èƒ½ä½¿ç”¨
    inst:RemoveTag("active_pot_pie")
    inst.pie_target = nil
    inst.components.inventoryitem.imagename = "portablecookpot_item"
    inst.components.inventoryitem.atlasname = "images/inventoryimages2.xml"

    return true
end)

ACTIONS.ACTIVATE_POT_PIE.mount_valid = true

-- 3) åœ¨ inventory ä¸­ä¸ºç›®æ ‡ prefab åŠ¨æ€æ·»åŠ è¿™ä¸ª Actionï¼ˆå³é”®èœå•ï¼‰
-- å½“ç©å®¶å³é”®èƒŒåŒ…ç‰©å“æ—¶ï¼Œå®¢æˆ·ç«¯ä¼šè°ƒç”¨è¿™ä¸ª hook å»å†³å®šæ˜¯å¦æ˜¾ç¤ºåŠ¨ä½œ
AddComponentAction("INVENTORY", "skypieinspiretool", function(inst, doer, actions, right)
    -- instï¼šç‰©å“å®ä½“ï¼›doerï¼šç©å®¶å®ä½“
    -- æˆ‘ä»¬åªä¸º portablecookpot_item æ·»åŠ åŠ¨ä½œï¼Œä¸”éœ€è¦ inst._is_activated ä¸º true ä¸”ä¸åœ¨å†·å´
    if inst and inst.prefab == "portablecookpot_item" and inst:HasTag("active_pot_pie") then
        if doer:HasTag("masterchef") and doer:HasTag("warly_sky_pie_pot") then -- æŠ€èƒ½æ ‘æ§åˆ¶
            table.insert(actions, ACTIONS.ACTIVATE_POT_PIE)
        end
    end
end)

-- 4) ç»™å¸¸è§çš„ StateGraph æ³¨å†Œ ActionHandler
AddStategraphActionHandler("wilson", ActionHandler(ACTIONS.ACTIVATE_POT_PIE, "spawn_warly_sky_pie"))
AddStategraphActionHandler("wilson_client", ActionHandler(ACTIONS.ACTIVATE_POT_PIE, "spawn_warly_sky_pie"))

-- 5) ç”»é¥¼çš„sg
AddStategraphState("wilson",
    State {
        name = "spawn_warly_sky_pie",
        tags = { "doing", "busy", "nocraftinginterrupt", "nomorph", "keep_pocket_rummage" },

        onenter = function(inst)
            inst.components.locomotor:Stop()
            inst.AnimState:PlayAnimation("wormwood_cast_spawn_pre")
            inst.AnimState:PushAnimation("wormwood_cast_spawn", false)
            inst.sg.statemem.action = inst.bufferedaction
        end,

        timeline =
        {
            FrameEvent(0, function(inst)
                inst.SoundEmitter:PlaySound("dontstarve/common/fireAddFuel")
                inst.SoundEmitter:PlaySound("dontstarve/wilson/cook")
                local fx = SpawnPrefab("warly_sky_pie_cook_fx")
                local x, y, z = inst.Transform:GetWorldPosition()
                fx.Transform:SetPosition(x, y + 1, z)
            end),
            FrameEvent(24, function(inst)
                inst:PerformBufferedAction()
            end),
            FrameEvent(38, function(inst)
                inst.sg:RemoveStateTag("busy")
            end),
            -- FrameEvent(42, TryResumePocketRummage),
        },

        events =
        {
            EventHandler("animqueueover", function(inst)
                if inst.AnimState:AnimDone() then
                    inst.sg:GoToState("idle")
                end
            end),
        },

        onexit = function(inst)
            if inst.bufferedaction == inst.sg.statemem.action and
                (not inst.components.playercontroller or inst.components.playercontroller.lastheldaction ~= inst.bufferedaction) then
                inst:ClearBufferedAction()
            end
            -- CheckPocketRummageMem(inst)
        end,
    }
)

AddStategraphState("wilson_client",
    State {
        name = "spawn_warly_sky_pie",
        tags = { "doing", "busy" },
        server_states = { "spawn_warly_sky_pie" },

        onenter = function(inst)
            inst.components.locomotor:Stop()
            inst.AnimState:PlayAnimation("wormwood_cast_spawn_pre")
            inst.AnimState:PlayAnimation("wormwood_cast_spawn_lag", false)

            inst:PerformPreviewBufferedAction()
            inst.sg:SetTimeout(1)
        end,

        onupdate = function(inst)
            if inst.sg:ServerStateMatches() then
                if inst.entity:FlattenMovementPrediction() then
                    inst.sg:GoToState("idle", "noanim")
                end
            elseif inst.bufferedaction == nil then
                inst.AnimState:PlayAnimation("wormwood_cast_spawn")
                inst.AnimState:SetFrame(37)
                inst.sg:GoToState("idle", true)
            end
        end,

        ontimeout = function(inst)
            inst:ClearBufferedAction()
            inst.AnimState:PlayAnimation("wormwood_cast_spawn")
            inst.AnimState:SetFrame(37)
            inst.sg:GoToState("idle", true)
        end,
    }
)

-- 6) è¿‡é‡åƒä¸œè¥¿æŠµæ¶ˆç”»é¥¼buff
AddComponentPostInit("eater", function(Eater)
    local old_Eater_Eat_delta_buff = Eater.Eat

    function Eater:Eat(food, feeder)
        if not food then
            return old_Eater_Eat_delta_buff(self, food, feeder)
        end

        local stack_mult = self.eatwholestack and food.components.stackable ~= nil and
            food.components.stackable:StackSize() or 1

        -- è®°å½•å½“å‰å±æ€§å€¼
        local hunger_comp = self.inst.components.hunger
        local sanity_comp = self.inst.components.sanity
        local health_comp = self.inst.components.health

        local cur_hunger = hunger_comp and hunger_comp.current or 0
        local cur_sanity = sanity_comp and sanity_comp.current or 0
        local cur_health = health_comp and health_comp.currenthealth or 0

        local max_hunger = hunger_comp and hunger_comp.max or 0
        local max_sanity = sanity_comp and sanity_comp.max or 0
        local max_health = health_comp and health_comp.maxhealth or 0

        -- è‡ªè¡Œè®¡ç®—é£Ÿç‰©æä¾›é‡
        local health_delta = food.components.edible and food.components.edible:GetHealth(self.inst) * stack_mult or 0
        local hunger_delta = food.components.edible and food.components.edible:GetHunger(self.inst) * stack_mult or 0
        local sanity_delta = food.components.edible and food.components.edible:GetSanity(self.inst) * stack_mult or 0

        -- è®¡ç®—æº¢å‡ºé‡ï¼ˆä¸è®¡ç®—æ²ƒåˆ©çš„é£Ÿç‰©è®°å¿†ï¼Œç»™æ²ƒåˆ©ä¸€ç‚¹ç©ºå­ï¼‰
        local overflow_health = math.max((cur_health + health_delta) - max_health, 0)
        local overflow_hunger = math.max((cur_hunger + hunger_delta) - max_hunger, 0)
        local overflow_sanity = math.max((cur_sanity + sanity_delta) - max_sanity, 0)

        -- è°ƒç”¨åŸå§‹Eaté€»è¾‘
        old_Eater_Eat_delta_buff(self, food, feeder)

        -- æ‰£é™¤buffå¾…æ‰£é‡
        if self.inst:HasDebuff("warly_sky_pie_inspire_buff") then
            local buff = self.inst:GetDebuff("warly_sky_pie_inspire_buff")
            if buff then
                if overflow_hunger > 0 then
                    buff._restore_hunger = math.max(0, (buff._restore_hunger or 0) - overflow_hunger)
                    -- print("[SkyPieBuff] é¥¥é¥¿æŠµæ¶ˆ:", overflow_hunger, "å‰©ä½™å¾…æ‰£", buff._restore_hunger)
                end
                if overflow_sanity > 0 then
                    buff._restore_sanity = math.max(0, (buff._restore_sanity or 0) - overflow_sanity)
                    -- print("[SkyPieBuff] ç†æ™ºæŠµæ¶ˆ:", overflow_sanity, "å‰©ä½™å¾…æ‰£", buff._restore_sanity)
                end
                if overflow_health > 0 then
                    buff._restore_health = math.max(0, (buff._restore_health or 0) - overflow_health)
                    -- print("[SkyPieBuff] ç”Ÿå‘½æŠµæ¶ˆ:", overflow_health, "å‰©ä½™å¾…æ‰£", buff._restore_health)
                end
            end
        end

        return true
    end
end)

-- 7) è¡¥å……é€»è¾‘ï¼Œæ¿€æ´»æŠ€èƒ½ç‚¹çš„æ—¶å€™æ¿€æ´»é”…çš„æ‰«æ
function UpdatePiePotSpells(inst)
    -- è·å–æŠ€èƒ½æ ‘æ›´æ–°ç»„ä»¶
    local skilltreeupdater = inst.components.skilltreeupdater
    -- åˆ¤æ–­æŠ€èƒ½æ˜¯å¦æ¿€æ´»
    local hasSkill = (skilltreeupdater ~= nil and skilltreeupdater:IsActivated("warly_sky_pie_pot"))

    -- å¦‚æœæŠ€èƒ½æ¿€æ´»ï¼Œæ¿€æ´»é”…çš„æ‰«æ
    if hasSkill then
        -- è·å–ç©å®¶èƒŒåŒ…ä¸­æ‰€æœ‰å¸¦æœ‰"skypieinspiretool"æ ‡ç­¾çš„ç‰©å“
        local inventory = inst.components.inventory
        if inventory then
            local items = inventory:GetItemsWithTag("skypieinspiretool")
            if items then
                for _, item in ipairs(items) do
                    -- æ¿€æ´»é”…çš„æ‰«æåŠŸèƒ½
                    if item.StartDetection then
                        item:StartDetection()
                    end
                end
            end
        end
    else
        -- å¦‚æœæŠ€èƒ½å–æ¶ˆï¼Œåœæ­¢é”…çš„æ‰«æ
        local inventory = inst.components.inventory
        if inventory then
            local items = inventory:GetItemsWithTag("skypieinspiretool")
            if items then
                for _, item in ipairs(items) do
                    -- åœæ­¢é”…çš„æ‰«æåŠŸèƒ½
                    if item.StopDetection then
                        item:StopDetection()
                    end
                end
            end
        end
    end
end

AddPrefabPostInit("warly", function(inst)
    -- ç›‘å¬æŠ€èƒ½æ¿€æ´»å’Œå–æ¶ˆ
    local onskillrefresh_client = function(inst) UpdatePiePotSpells(inst) end
    local onskillrefresh_server = function(inst) UpdatePiePotSpells(inst) end
    inst:ListenForEvent("onactivateskill_server", onskillrefresh_server)
    inst:ListenForEvent("ondeactivateskill_server", onskillrefresh_server)
    inst:ListenForEvent("onactivateskill_client", onskillrefresh_client)
    inst:ListenForEvent("ondeactivateskill_client", onskillrefresh_client)
end)



-- local function lamp_turnon(inst)
--     -- inst.AnimState:PlayAnimation("idle")
--     -- inst.AnimState:OverrideSymbol("swap_food", "cook_pot_food", "meatballs")
--     --     inst.AnimState:SetBank("flint")
--     -- inst.AnimState:SetBuild("flint")
--     -- inst.AnimState:PlayAnimation("idle")
-- end

-- local function lamp_ondropped(inst)
--     -- Works because of the IsEmpty check in turnon
--     -- lamp_turnoff(inst)
--     -- lamp_turnon(inst)
--     inst.AnimState:SetBank("flint")
--     inst.AnimState:SetBuild("flint")
--     inst.AnimState:PlayAnimation("idle", true)
-- end

-- AddPrefabPostInit("meatballs", function(inst)
--     inst.entity:AddFollower()
--     inst:AddTag("furnituredecor") 
--     local furnituredecor = inst:AddComponent("furnituredecor")
--     -- furnituredecor.onputonfurniture = lamp_ondropped
-- end)
-- AddPrefabPostInit("flint", function(inst)
--     inst.entity:AddFollower()
--     local furnituredecor = inst:AddComponent("furnituredecor")
--     furnituredecor.onputonfurniture = lamp_ondropped

--     -- ğŸ”§ å…³é”®ï¼šå¼ºåˆ¶åˆ·æ–°æ˜¾ç¤º

-- end)
-- AddPrefabPostInit("decor_food", function(inst)
--     inst.entity:AddFollower()
-- end)
-- AddPrefabPostInit("decor_lamp", function(inst)
--     inst.AnimState:SetBank("flint")
--     inst.AnimState:SetBuild("flint")
--     inst.AnimState:PlayAnimation("idle")
-- end)


-- modmain.lua ï¼ˆæˆ–ä½ çš„ä¸»è„šæœ¬ï¼‰
local ACTION_PLACE_FOOD_ON_TABLE = AddAction("PLACE_FOOD_ON_TABLE", "Place on table", -- perform fn:
    function(act)
        local doer = act.doer
        local target = act.target
        local invobject = act.invobject -- the item in-hand (preparedfood)
        if not (doer and target and invobject) then return end
        if not (target:HasTag("decortable") and target:HasTag("structure")) then return end
        if not invobject:HasTag("preparedfood") then return end
        if doer.prefab ~= "warly" then return end

        -- server side logic (this function runs on server)
        -- ensure table netvars exist (create if missing)
        if not target.has_table_food then
            target.has_table_food = net_bool(target.GUID, "decortable.has_table_food")
            target.table_food_hunger = net_float(target.GUID, "decortable.table_food_hunger")
        end

        local function SetTableFood(inst, prefabname, hunger)
            if prefabname and prefabname ~= "" then
                inst.has_table_food:set(true)
                inst.table_food_hunger:set(hunger or 0)
            else
                inst.has_table_food:set(false)
                inst.table_food_hunger:set(0)
            end
        end

        local function SpawnDecorFoodFor(inst, item)
            local x, y, z = inst.Transform:GetWorldPosition()
            local decor = SpawnPrefab("decor_food")
            if not decor then return nil end

            -- ç¡®ä¿é£Ÿç‰©å­˜åœ¨ AnimState
            if decor.AnimState then
                -- æ‰“å°è°ƒè¯•ä¿¡æ¯ï¼Œæ£€æŸ¥ä¼ é€’çš„å‚æ•°
                print("[DecorFood] åå­—prefab: ", item.prefab, "food_symbol_build:", item.food_symbol_build or "cook_pot_food", "food_basename:", item.food_basename)

                -- å¤„ç†è°ƒæ–™
                local spicename = nil
                if item.components and item.components.edible and item.components.edible.spice then
                    spicename = string.lower(item.components.edible.spice)
                elseif item.spice then
                    spicename = string.lower(item.spice)
                end
                print("[DecorFood] è°ƒæ–™: ", spicename)

                -- è®¾ç½®é£Ÿç‰©çš„buildå’Œbank
                if spicename ~= nil then
                    decor.AnimState:SetBuild("plate_food")
                    decor.AnimState:SetBank("plate_food")
                    decor.AnimState:OverrideSymbol("swap_garnish", "spices", spicename)
                    decor:AddTag("spicedfood")
                else
                    decor.AnimState:SetBuild(item.food_symbol_build or "cook_pot_food")
                    decor.AnimState:SetBank("cook_pot_food")
                end

                decor.AnimState:OverrideSymbol("swap_food", item.food_symbol_build or "cook_pot_food", item.food_basename or item.prefab)

                -- è¦†ç›–é£Ÿç‰©ç¬¦å·
                if decor.Physics then decor.Physics:SetActive(false) end
                if decor.Follower then decor.Follower:FollowSymbol(inst.GUID, "swap_object") end
                -- decor.components.inventoryitem:DoDropPhysics(x, y, z, 1, 1)

                print("[DecorFood] Finished applying symbols.")
            else
                print("[DecorFood] No AnimState found on decor!")
            end

            -- è¿”å›è£…é¥°ç‰©
            return decor
        end

        -- read hunger
        local hunger = 0
        if invobject.components and invobject.components.edible then
            hunger = invobject.components.edible.hungervalue or 0
        end

        -- set table state
        SetTableFood(target, invobject.food_basename or invobject.prefab, hunger)

        -- spawn decor visual and store reference on server
        local decor = SpawnDecorFoodFor(target, invobject)
        target._table_decor_food = decor

        -- disable accepting other decor
        if target.components.furnituredecortaker then
            target.components.furnituredecortaker:SetEnabled(false)
        end

        target:AddTag("has_table_food")

        -- play sound
        if target.SoundEmitter then
            target.SoundEmitter:PlaySound("wintersfeast2019/winters_feast/table/food")
        end

        -- remove original food item (stack handling)
        if invobject.components.stackable and invobject.components.stackable:IsStack() then
            invobject.components.stackable:Get():Remove()
        else
            invobject:Remove()
        end

        -- Done
        return true
    end
)

-- Make the action appear when using a preparedfood from inventory onto a table
AddComponentAction("USEITEM", "inventoryitem", function(inst, doer, target, actions, right)
    if not target or not doer or not inst then return end
    if not target:HasTag("has_table_food") and not target:HasTag("hasfurnituredecoritem") and target:HasTag("decortable") and target:HasTag("structure") and inst:HasTag("preparedfood") and doer.prefab == "warly" then
        table.insert(actions, ACTIONS.PLACE_FOOD_ON_TABLE)
    end
end)

-- Add a stategraph action handler so the player plays the short action animation
AddStategraphActionHandler("wilson", ActionHandler(ACTIONS.PLACE_FOOD_ON_TABLE, "dolongaction"))
AddStategraphActionHandler("wilson_client", ActionHandler(ACTIONS.PLACE_FOOD_ON_TABLE, "dolongaction"))


-- ---- ç¬¬äºŒä¸ªåŠ¨ä½œï¼šå½“æ¡Œå­è¢«å ç”¨ä¸” doer.hunger == 0 æ—¶ï¼Œå³é”®æ¡Œå­æ¢å¤é¥¥é¥¿å¹¶é‡Šæ”¾æ¡Œå­ ----
local ACTION_CONSUME_TABLE_FOOD = AddAction("CONSUME_TABLE_FOOD", "Consume table food",
    function(act)
        local doer = act.doer
        local target = act.target
        if not (doer and target) then return end
        if not target.has_table_food then
            -- ensure netvars exist
            target.has_table_food = net_bool(target.GUID, "decortable.has_table_food")
            target.table_food_hunger = net_float(target.GUID, "decortable.table_food_hunger")
        end
        if not target.has_table_food:value() then
            return
        end
        if not doer.components or not doer.components.hunger then return end
        -- only allow when hunger is zero (<=0 used for safety)
        if doer.components.hunger.current > 0 then
            return
        end

        -- give hunger
        local give = target.table_food_hunger:value() or 0
        if give > 0 then
            doer.components.hunger:DoDelta(give, true, "table_food_consume")
        end

        -- clear table visuals & state (server)
        if target._table_decor_food then
            if target._table_decor_food.Follower then
                target._table_decor_food.Follower:StopFollowing()
            end
            target._table_decor_food:Remove()
            target._table_decor_food = nil
        end

        -- clear netvars
        target.has_table_food:set(false)
        target.table_food_hunger:set(0)

        target:RemoveTag("has_table_food")

        if target.components.furnituredecortaker then
            target.components.furnituredecortaker:SetEnabled(true)
        end

        if target.SoundEmitter then
            target.SoundEmitter:PlaySound("dontstarve/common/eat")
        end

        return true
    end
)

-- Make the action appear on right-click context if table is occupied and doer hunger == 0
AddComponentAction("SCENE", "furnituredecortaker", function(inst, doer, actions, right)
    -- ensure netvars exist
    if not inst.has_table_food then
        inst.has_table_food = net_bool(inst.GUID, "decortable.has_table_food")
        inst.table_food_hunger = net_float(inst.GUID, "decortable.table_food_hunger")
    end
    if inst.has_table_food:value() then
        table.insert(actions, ACTIONS.CONSUME_TABLE_FOOD)
    end
end)

AddStategraphActionHandler("wilson", ActionHandler(ACTIONS.CONSUME_TABLE_FOOD, "doshortaction"))
AddStategraphActionHandler("wilson_client", ActionHandler(ACTIONS.CONSUME_TABLE_FOOD, "doshortaction"))


-- ---- è§†è§‰æ›´æ–°çš„ä¿åº•ï¼ˆåœ¨è¡¨å®ä¾‹åˆ›å»ºæ—¶ï¼Œç¡®ä¿æ¡Œå­ä¸Šæ˜¾ç¤º swap_object ä¸º table_food_prefabï¼‰ ----
-- local function EnsureTableNetvarsAndVisuals(inst, data)
--     -- call this in AddTable's fn after inst.entity:SetPristine() OR register globally with AddPrefabPostInit for tables
--     if not inst.has_table_food then
--         inst.has_table_food = net_bool(inst.GUID, "decortable.has_table_food")
--         inst.table_food_hunger = net_float(inst.GUID, "decortable.table_food_hunger")
--     end

--     local function UpdateVisual()
--         if not inst.AnimState then return end
--         if pref and pref ~= "" then
--             inst.AnimState:OverrideSymbol("swap_object", "cook_pot_food", pref)
--         else
--             -- attempt to clear override by restoring table's own symbol (best-effort)
--             inst.AnimState:ClearOverrideSymbol("swap_object")
--         end
--     end

--     inst:DoPeriodicTask(0.5, UpdateVisual) -- periodic refresh to keep client visuals in sync
--     inst:DoTaskInTime(0, UpdateVisual)
-- end

-- -- Optionally: call EnsureTableNetvarsAndVisuals for all table prefabs on prefab init:
-- AddPrefabPostInit("wood_table_round", function(inst) EnsureTableNetvarsAndVisuals(inst) end)
-- AddPrefabPostInit("wood_table_square", function(inst) EnsureTableNetvarsAndVisuals(inst) end)
-- AddPrefabPostInit("stone_table_round", function(inst) EnsureTableNetvarsAndVisuals(inst) end)
-- AddPrefabPostInit("stone_table_square", function(inst) EnsureTableNetvarsAndVisuals(inst) end)
